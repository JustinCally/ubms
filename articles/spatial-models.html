<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spatial Models in ubms • ubms</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Spatial Models in ubms">
<meta property="og:description" content="ubms">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ubms</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ubms.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/JAGS-comparison.html">Comparing models fit in ubms and JAGS</a>
    </li>
    <li>
      <a href="../articles/random-effects.html">Random effects in ubms</a>
    </li>
    <li>
      <a href="../articles/spatial-models.html">Spatial Models in ubms</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kenkellner/ubms/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Spatial Models in ubms</h1>
                        <h4 class="author">Ken Kellner</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/kenkellner/ubms/blob/master/vignettes/spatial-models.Rmd"><code>vignettes/spatial-models.Rmd</code></a></small>
      <div class="hidden name"><code>spatial-models.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>In many studies of animal and plant occurrence and abundance, sites may not be entirely independent. For example, sites may be close together, or site size may be smaller than a typical home range. In these cases we expect spatial autocorrelation among nearby sites. Ideally, this autocorrelation would be accounted for in models.</p>
<p>A solution to this problem is so-called spatial occupancy models, which include spatial random effects. A common approach to handling spatial autocorrelation is the use of an intrinsic conditional autoregressive (ICAR) random effect <span class="citation">(Banerjee, Carlin, and Gelfand <a href="#ref-Banerjee_2014" role="doc-biblioref">2014</a>)</span>. The growing accessibility of Bayesian approaches has facilitated fitting these models. However, fitting ICAR models is computationally intensive and the ICAR random effect may be correlated with fixed covariates included in the model, making inference difficult <span class="citation">(Hodges and Reich <a href="#ref-Hodges_2010" role="doc-biblioref">2010</a>)</span>. To solve these issues, Johnson et al. <span class="citation">(<a href="#ref-Johnson_2013" role="doc-biblioref">2013</a>)</span> extended restricted spatial regression (RSR) to occupancy models. In an RSR model, the random effect is constructed in such a way that it is uncorrelated with the fixed covariates, and it can be significantly less computationally intensive than ICAR to estimate <span class="citation">(Broms et al. <a href="#ref-Broms_2014" role="doc-biblioref">2014</a>)</span>. Broms et al. <span class="citation">(Broms et al. <a href="#ref-Broms_2014" role="doc-biblioref">2014</a>)</span> provide a nice overview of the concepts. Several recent studies have shown that RSR provides better and faster inference than ICAR <span class="citation">(e.g. Broms et al. <a href="#ref-Broms_2014" role="doc-biblioref">2014</a>; Clark and Altwegg <a href="#ref-Clark_2019" role="doc-biblioref">2019</a>)</span>. At least two specialized R packages (<a href="https://cran.r-project.org/package=stocc"><code>stocc</code></a> and <a href="https://github.com/AllanClark/Rcppocc"><code>Rcppocc</code></a>) are available for fitting ICAR and RSR occupancy models.</p>
<p>It is now possible to fit RSRs in Stan with <code>ubms</code> as well, allowing those familiar with <code>unmarked</code>/<code>ubms</code> syntax and workflows to easily fit spatial models. Currently all single-season models in <code>ubms</code> are supported. In addition to fitting RSRs, <code>ubms</code> also provides tools for applying and visualizing fitted spatial models. For now these features are available in the dev version of <code>ubms</code>, which you can install with the following code:</p>
</div>
<div id="example" class="section level1">
<h1 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h1>
<p>We will adapt the demo code and dataset available in R package <code>stocc</code> to fit a spatial occupancy model, which will also facilitate a comparison between <code>stocc</code> and <code>ubms</code> results. The <code>stocc</code> package was an extremely valuable guide when implementing RSRs in <code>ubms</code>, and contains many other useful features related to spatial occupancy modeling.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://kenkellner.com/ubms/">ubms</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">stocc</span><span class="op">)</span></pre></div>
<div id="format-the-input-data" class="section level2">
<h2 class="hasAnchor">
<a href="#format-the-input-data" class="anchor"></a>Format the input data</h2>
<p>The sample dataset that comes with <code>stocc</code> is in long format. We need to convert it to the wide format that <code>unmarked</code> and <code>ubms</code> expect.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># Load datasets</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">habData</span><span class="op">)</span>   <span class="co"># site covariate data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">visitData</span><span class="op">)</span> <span class="co"># observation cov data</span>

<span class="co"># Visits per site</span>
<span class="va">nobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">visitData</span><span class="op">$</span><span class="va">site</span>, <span class="va">visitData</span><span class="op">$</span><span class="va">obs</span><span class="op">)</span>

<span class="co"># Dimensions of y matrix</span>
<span class="va">J</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">nobs</span><span class="op">)</span>     <span class="co"># max obs per site</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">habData</span><span class="op">)</span> <span class="co"># no. of sites</span>

<span class="co"># Create blank matrices to hold wide-format versions</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">detCov1</span> <span class="op">&lt;-</span> <span class="va">detCov2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">M</span>, ncol<span class="op">=</span><span class="va">J</span><span class="op">)</span>

<span class="co"># Iterate over sites</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># Data from site i</span>
  <span class="va">sub</span> <span class="op">&lt;-</span> <span class="va">visitData</span><span class="op">[</span><span class="va">visitData</span><span class="op">$</span><span class="va">site</span><span class="op">==</span><span class="va">i</span>,<span class="op">]</span>
  <span class="co"># Put this data into our wide matrices</span>
  <span class="va">subJ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sub</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">subJ</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw">next</span>
  <span class="va">y</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">:</span><span class="va">subJ</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sub</span><span class="op">$</span><span class="va">obs</span>
  <span class="va">detCov1</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">:</span><span class="va">subJ</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sub</span><span class="op">$</span><span class="va">detCov1</span>
  <span class="va">detCov2</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">:</span><span class="va">subJ</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">sub</span><span class="op">$</span><span class="va">detCov2</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Make site and obs cov data frames</span>
<span class="va">site_cov</span> <span class="op">&lt;-</span> <span class="va">habData</span>
<span class="va">obs_cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>detCov1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">detCov1</span><span class="op">)</span><span class="op">)</span>, detCov2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">detCov2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Convert detCov2 back into a factor (as it was originally)</span>
<span class="va">obs_cov</span><span class="op">$</span><span class="va">detCov2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">obs_cov</span><span class="op">$</span><span class="va">detCov2</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0"</span>,<span class="st">"1"</span>,<span class="st">"2"</span>,<span class="st">"3"</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>In order to fit a spatial model, we need coordinates included in our site covariates. These should be in some projected coordinate system. In this dataset, coordinates are contained in columns <code>x</code> and <code>y</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">site_cov</span><span class="op">)</span></pre></div>
<pre><code>##   site   x   y habCov1    habCov2
## 1    1 0.5 0.5       1 -1.4189386
## 2    2 0.5 1.5       1 -1.4081437
## 3    3 0.5 2.5       1 -1.1183479
## 4    4 0.5 3.5       1 -0.7852142
## 5    5 0.5 4.5       1 -0.6260133
## 6    6 0.5 5.5       1 -0.6122186</code></pre>
<p>Site and observation covariates are otherwise handled the same way as normal for <code>unmarked</code> and <code>ubms</code> models. Here’s a quick visualization of how <code>habCov2</code> varies across the study area.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="co">#Which sites were sampled at least once?</span>
<span class="va">sampled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">site_cov</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">habCov2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">site_cov</span><span class="op">[</span><span class="va">sampled</span>,<span class="op">]</span>, size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span>colors<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">heat.colors</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span>base_size<span class="op">=</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="spatial_cov-1.png"></p>
<p>The black dots represent locations that were sampled at least once. Note that not all grid cells with available site covariates were actually sampled; in fact most of them were not. For typical models, <code>ubms</code> would just ignore a site that was present in the dataset but never sampled (i.e., <code>y</code> all <code>NA</code>) since these sites cannot contribute any information. However for spatial models, generating predictive maps across areas that may not have been sampled is a typical goal. To facilitate this, spatial models in <code>ubms</code> do not discard sites which were never sampled but that have available site covariates. As you’d expect, you simply include these by including a row of all missing values in <code>y</code> and your observation covariates, as appropriate. For example, in this dataset, sites 1 and 2 were sampled but site 3 was not:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="op">]</span></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7]
## [1,]    1    1    1    1   NA   NA   NA
## [2,]    1    1    1   NA   NA   NA   NA
## [3,]   NA   NA   NA   NA   NA   NA   NA</code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">detCov1</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="op">]</span>,<span class="fl">3</span><span class="op">)</span></pre></div>
<pre><code>##        [,1]   [,2]   [,3]   [,4] [,5] [,6] [,7]
## [1,]  1.474 -0.220  1.112 -1.254   NA   NA   NA
## [2,] -1.602  1.349 -0.690     NA   NA   NA   NA
## [3,]     NA     NA     NA     NA   NA   NA   NA</code></pre>
<p>The final step in data formatting is to construct the <code>unmarkedFrame</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">umf</span> <span class="op">&lt;-</span> <span class="fu">unmarkedFrameOccu</span><span class="op">(</span>y<span class="op">=</span><span class="va">y</span>, siteCovs<span class="op">=</span><span class="va">site_cov</span>, obsCovs<span class="op">=</span><span class="va">obs_cov</span><span class="op">)</span></pre></div>
</div>
<div id="choose-rsr-options" class="section level2">
<h2 class="hasAnchor">
<a href="#choose-rsr-options" class="anchor"></a>Choose RSR options</h2>
<p>Next, we need to decide on settings for the RSR. Specifically, we need to decide the distance threshold below which two sites will be considered neighbors and thus potentially correlated with each other. For example, if site A and site B are 0.5 distance units apart and we set the threshold at 1, A and B will be considered neighbors. If A and B are 1.5 distance units apart, they will not be neighbors. The distance units are defined by the units of the coordinates you provided.</p>
<p>To visualize this, we can use the <code><a href="../reference/RSR.html">RSR()</a></code> function, which we will use again later when fitting the model. The RSR() function requires as input at least one coordinate vector (typically you will have 2, e.g. <code>x</code> and <code>y</code>) and a value for the <code>threshold</code> argument. If we set the <code>plot_site</code> argument to an integer, <code>RSR</code> will return a map highlighting that site and its neighbors under the current threshold setting:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">site_cov</span>, <span class="fu"><a href="../reference/RSR.html">RSR</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, threshold<span class="op">=</span><span class="fl">1</span>, plot_site<span class="op">=</span><span class="fl">300</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="spatial_threshold1-1.png"></p>
<p>With <code>threshold=1</code> and our coordinate grid, site 300 has just 4 neighbors. Now consider <code>threshold=10</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">site_cov</span>, <span class="fu"><a href="../reference/RSR.html">RSR</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, threshold<span class="op">=</span><span class="fl">10</span>, plot_site<span class="op">=</span><span class="fl">300</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="spatial_threshold10-1.png"></p>
<p>The threshold choice depends on your modeling goals and study system, but it is probably best to start with sites having a relatively small number of neighbors. We will set <code>threshold=1</code> for this example.</p>
<p>A final argument available in <code><a href="../reference/RSR.html">RSR()</a></code> is <code>moran_cut</code>. This option controls the number of eigenvectors that are used when calculating the spatial random effect (possible values are 1 to the number of sites). Generally, with fewer eigenvectors, the model will run faster and the result will be smoother. Previous studies have shown that inference is not particularly sensitive to this value, and recommended it be set to 10% of the number of sites <span class="citation">(Broms et al. <a href="#ref-Broms_2014" role="doc-biblioref">2014</a>; Clark and Altwegg <a href="#ref-Clark_2019" role="doc-biblioref">2019</a>)</span>. This is the default in <code>ubms</code> so we will leave it alone.</p>
</div>
<div id="fit-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-the-model" class="anchor"></a>Fit the model</h2>
<p>We are finally ready to fit our spatial model. The formula syntax is identical to normal <code>ubms</code> and (and <code>unmarked</code>) models, except that we will include a call to <code><a href="../reference/RSR.html">RSR()</a></code> with our desired options in our formula for <code>psi</code>. We also include two fixed detection and two fixed occupancy covariates.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="co">#Double formula: first part is for detection, second for occupancy</span>
<span class="va">form</span> <span class="op">&lt;-</span> <span class="op">~</span><span class="va">detCov1</span> <span class="op">+</span> <span class="va">detCov2</span> <span class="op">~</span><span class="va">habCov1</span> <span class="op">+</span> <span class="va">habCov2</span> <span class="op">+</span> <span class="fu"><a href="../reference/RSR.html">RSR</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, threshold<span class="op">=</span><span class="fl">1</span><span class="op">)</span></pre></div>
<p>We will then fit the model in Stan with <code><a href="../reference/stan_occu.html">stan_occu()</a></code>, using 3 parallel cores. This will take Stan a few minutes with default MCMC settings.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="va">fit_ubms</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_occu.html">stan_occu</a></span><span class="op">(</span><span class="va">form</span>, <span class="va">umf</span>, chains<span class="op">=</span><span class="fl">3</span>, cores<span class="op">=</span><span class="fl">3</span><span class="op">)</span></pre></div>
<p>You will likely get some warnings about effective sample size. The solution is to run the model for more iterations, but this is good enough for an example.</p>
</div>
<div id="examine-results" class="section level2">
<h2 class="hasAnchor">
<a href="#examine-results" class="anchor"></a>Examine results</h2>
<p>Look at the parameter estimates:</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="va">fit_ubms</span></pre></div>
<pre><code>## 
## Call:
## stan_occu(formula = form, data = umf, chains = 3, refresh = 0, 
##     cores = 3)
## 
## Occupancy (logit-scale):
##             Estimate     SD    2.5%  97.5% n_eff Rhat
## (Intercept)   -1.038 0.2286 -1.5060 -0.601  1269 1.00
## habCov12      -0.212 0.3231 -0.8503  0.427  2404 1.00
## habCov13      -0.258 0.3273 -0.9035  0.374  2058 1.00
## habCov2        1.080 0.1708  0.7683  1.439  1429 1.00
## RSR [tau]      0.155 0.0589  0.0704  0.293   253 1.01
## 
## Detection (logit-scale):
##             Estimate    SD   2.5% 97.5% n_eff Rhat
## (Intercept)    1.727 0.370  1.004 2.481  1610    1
## detCov1        0.113 0.210 -0.310 0.533  4962    1
## detCov21       1.185 0.555  0.122 2.320  2189    1
## detCov22       1.372 0.557  0.356 2.496  2455    1
## detCov23      -0.242 0.484 -1.197 0.719  2013    1
## 
## LOOIC: 668.02</code></pre>
<p>The precision term (tau, <span class="math inline">\(\tau\)</span>) associated with the spatial random effect is the final row of the occupancy model estimates. Smaller values of <span class="math inline">\(\tau\)</span> imply greater variability in the spatial random effect.</p>
<p>There also appears to be a strong effect of <code>habCov2</code> on occupancy. We can quickly visualize marginal effects of fixed covariates with <code>plot_effects</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="fu"><a href="../reference/plot_effects,ubmsFit-method.html">plot_effects</a></span><span class="op">(</span><span class="va">fit_ubms</span>, <span class="st">"state"</span><span class="op">)</span></pre></div>
<p><img src="spatial_marginal-1.png"></p>
<p>You can extract predicted occupancy values for each site (including sites never actually sampled) using the <code>predict</code> function:</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="co"># "state" to get state/occupancy process, as opposed to "det"</span>
<span class="va">psi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict,ubmsFit-method.html">predict</a></span><span class="op">(</span><span class="va">fit_ubms</span>, <span class="st">"state"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">psi</span><span class="op">)</span></pre></div>
<pre><code>##   Predicted         SD       2.5%     97.5%
## 1 0.1441475 0.04413909 0.07266996 0.2439409
## 2 0.2360008 0.08352206 0.10501601 0.4271224
## 3 0.3578073 0.11260628 0.17170766 0.6029410
## 4 0.4527547 0.12485601 0.23020833 0.7192525
## 5 0.4522272 0.11820159 0.23762047 0.6955722
## 6 0.3847294 0.11279317 0.18753530 0.6292943</code></pre>
</div>
<div id="plotting" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting" class="anchor"></a>Plotting</h2>
<p>It is much more interesting to see how predicted occupancy varies across the study area. <code>ubms</code> has a built-in function for generating such a map, <code>plot_spatial</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="fu"><a href="../reference/plot_spatial.html">plot_spatial</a></span><span class="op">(</span><span class="va">fit_ubms</span><span class="op">)</span></pre></div>
<p><img src="spatial_psi-1.png"></p>
<p>The plot also shows the location of sampled sites and whether the species was ever detected at each one.</p>
<p>You can also look at the spatial distribution of random effects <span class="math inline">\(\eta\)</span>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="fu"><a href="../reference/plot_spatial.html">plot_spatial</a></span><span class="op">(</span><span class="va">fit_ubms</span>, <span class="st">"eta"</span><span class="op">)</span></pre></div>
<p><img src="spatial_eta-1.png"></p>
</div>
<div id="model-selection" class="section level2">
<h2 class="hasAnchor">
<a href="#model-selection" class="anchor"></a>Model selection</h2>
<p>It is important to confirm that the spatial random effect is actually improving the predictive power of the model; if it isn’t, we ought to remove it. To check this, first fit a similar model without the RSR:</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="va">fit_nonspatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_occu.html">stan_occu</a></span><span class="op">(</span><span class="op">~</span><span class="va">detCov1</span> <span class="op">+</span> <span class="va">detCov2</span> <span class="op">~</span><span class="va">habCov1</span> <span class="op">+</span> <span class="va">habCov2</span>, <span class="va">umf</span>, chains<span class="op">=</span><span class="fl">3</span><span class="op">)</span></pre></div>
<p>Combine the models to compare into a <code>fitList</code> (note: they must have the same number of chains and MCMC iterations):</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitList,ubmsFit-method.html">fitList</a></span><span class="op">(</span><span class="va">fit_ubms</span>, <span class="va">fit_nonspatial</span><span class="op">)</span></pre></div>
<p>Then, compare the spatial and non-spatial models with leave-one-out cross-validation (LOO)<span class="citation">(Vehtari, Gelman, and Gabry <a href="#ref-Vehtari_2017" role="doc-biblioref">2017</a>)</span> using the <code>modSel()</code> function:</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu">modSel</span><span class="op">(</span><span class="va">fl</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></pre></div>
<pre><code>##                   elpd nparam elpd_diff se_diff weight
## fit_ubms       -334.01  44.80      0.00     0.0      1
## fit_nonspatial -380.54   8.43    -46.53     8.1      0</code></pre>
<p>A measure of predictive accuracy (<code>elpd</code>) is shown for each model, and the model with the highest predictive accuracy is listed first. The difference in <code>elpd</code> between the top and model and each subsequent model (<code>elpd_diff</code>), along with a measure of the uncertainty of that difference (<code>se_diff</code>), are also shown. If the magnitude of <code>elpd_diff</code> is large relative to the associated uncertainty, we can conclude that there is a difference in predictive power between the two models. In this case <code>elpd_diff</code> between the spatial (<code>fit_ubms</code>) and non-spatial (<code>fit_nonspatial</code>) models is several times the size of <code>se_diff</code>, so including the spatial random effect appears to improve model predictive accuracy.</p>
</div>
</div>
<div id="compare-with-stocc" class="section level1">
<h1 class="hasAnchor">
<a href="#compare-with-stocc" class="anchor"></a>Compare with stocc</h1>
<p>The implementation of spatial models in <code>ubms</code> owes much to the <code>stocc</code> package. The two packages give essentially identical results. To show this, we will fit the same model in <code>stocc</code> and compare the occupancy predictions with <code>ubms</code>. The code for fitting the model in <code>stocc</code> is taken directly from the package demo.</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="va">names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  visit<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>site<span class="op">=</span><span class="st">"site"</span>,obs<span class="op">=</span><span class="st">"obs"</span><span class="op">)</span>,
  site<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>site<span class="op">=</span><span class="st">"site"</span>, coords<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">fit_stocc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/stocc/man/spatial.occupancy.html">spatial.occupancy</a></span><span class="op">(</span>
  detection.model <span class="op">=</span> <span class="op">~</span> <span class="va">detCov1</span> <span class="op">+</span> <span class="va">detCov2</span>,
  occupancy.model <span class="op">=</span> <span class="op">~</span> <span class="va">habCov1</span> <span class="op">+</span> <span class="va">habCov2</span>,
  spatial.model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"rsr"</span>, threshold<span class="op">=</span><span class="fl">1</span>, moran.cut<span class="op">=</span><span class="fl">0.1</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">habData</span><span class="op">)</span><span class="op">)</span>,
  so.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/stocc/man/make.so.data.html">make.so.data</a></span><span class="op">(</span><span class="va">visitData</span>, <span class="va">habData</span>, <span class="va">names</span><span class="op">)</span>,
  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>a.tau<span class="op">=</span><span class="fl">0.5</span>, b.tau<span class="op">=</span><span class="fl">0.00005</span>, Q.b<span class="op">=</span><span class="fl">0.1</span>, Q.g<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span>,
  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>burnin<span class="op">=</span><span class="fl">1000</span><span class="op">/</span><span class="fl">5</span>, iter<span class="op">=</span><span class="fl">4000</span><span class="op">/</span><span class="fl">5</span>, thin<span class="op">=</span><span class="fl">5</span><span class="op">)</span>
  <span class="op">)</span></pre></div>
<p>Here’s a similar plot of predicted occupancy across the study area:</p>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="co"># Predicted occupancy</span>
<span class="va">psi_stocc</span> <span class="op">&lt;-</span> <span class="va">fit_stocc</span><span class="op">$</span><span class="va">occupancy.df</span><span class="op">$</span><span class="va">psi.est</span>

<span class="co"># Sites that were sampled at least once</span>
<span class="va">sampled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fu">getY</span><span class="op">(</span><span class="va">umf</span><span class="op">)</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">habData</span>, psi<span class="op">=</span><span class="va">psi_stocc</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col<span class="op">=</span><span class="va">psi</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">5</span>, pch<span class="op">=</span><span class="fl">15</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_color_gradientn</a></span><span class="op">(</span>colors<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">terrain.colors</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">plot_data</span><span class="op">[</span><span class="va">sampled</span>,<span class="op">]</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>col<span class="op">=</span><span class="st">"psi"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span>base_size<span class="op">=</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        strip.background<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span><span class="st">"white"</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="spatial_stocc-1.png"></p>
<p>As you can see, the predicted occupancy maps for <code>ubms</code> and <code>stocc</code> are almost identical. Note, however, that coefficient estimates may not be identical because <code>stocc</code> uses a probit link function, while <code>ubms</code> uses a logit link.</p>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs">
<div id="ref-Banerjee_2014">
<p>Banerjee, Sudipto, Bradley P Carlin, and Alan E Gelfand. 2014. <em>Hierarchical Modeling and Analysis for Spatial Data</em>. CRC press.</p>
</div>
<div id="ref-Broms_2014">
<p>Broms, Kristin M., Devin S. Johnson, Res Altwegg, and Loveday L. Conquest. 2014. “Spatial Occupancy Models Applied to Atlas Data Show Southern Ground Hornbills Strongly Depend on Protected Areas.” <em>Ecological Applications</em> 24 (2): 363–74. <a href="https://doi.org/https://doi.org/10.1890/12-2151.1">https://doi.org/https://doi.org/10.1890/12-2151.1</a>.</p>
</div>
<div id="ref-Clark_2019">
<p>Clark, Allan E., and Res Altwegg. 2019. “Efficient Bayesian Analysis of Occupancy Models with Logit Link Functions.” <em>Ecology and Evolution</em> 9 (2): 756–68. <a href="https://doi.org/https://doi.org/10.1002/ece3.4850">https://doi.org/https://doi.org/10.1002/ece3.4850</a>.</p>
</div>
<div id="ref-Hodges_2010">
<p>Hodges, James S, and Brian J Reich. 2010. “Adding Spatially-Correlated Errors Can Mess up the Fixed Effect You Love.” <em>The American Statistician</em> 64 (4): 325–34.</p>
</div>
<div id="ref-Johnson_2013">
<p>Johnson, Devin S., Paul B. Conn, Mevin B. Hooten, Justina C. Ray, and Bruce A. Pond. 2013. “Spatial Occupancy Models for Large Data Sets.” <em>Ecology</em> 94 (4): 801–8. <a href="https://doi.org/https://doi.org/10.1890/12-0564.1">https://doi.org/https://doi.org/10.1890/12-0564.1</a>.</p>
</div>
<div id="ref-Vehtari_2017">
<p>Vehtari, Aki, Andrew Gelman, and Jonah Gabry. 2017. “Practical Bayesian Model Evaluation Using Leave-One-Out Cross-Validation and WAIC.” <em>Statistics and Computing</em> 27 (5): 1413–32. <a href="https://doi.org/10.1007/s11222-016-9696-4">https://doi.org/10.1007/s11222-016-9696-4</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://kenkellner.com">Ken Kellner</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
